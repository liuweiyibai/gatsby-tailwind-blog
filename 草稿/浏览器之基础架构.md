---
title: 浏览器基础架构
---

## CPU 与 GPU

CPU 和 GPU 作为计算机中最重要的两个计算单元直接决定了计算性能。

CPU 是计算机的大脑，负责处理各种不同的任务。在过去，大多数 CPU 是单芯片的，核心被安置在同一个芯片上。更新的 CPU 可以支持多核心，运算能力大大加强。而最新的的 CPU 已经达到 10 核心 20 线程数的能力了。

GPU 是另一个计算机的组成部分，与 CPU 不同，GPU 更擅长利用多核心同时处理单一的任务。像命名那样，GPU 最初被用于处理图像。这就是为什么使用 GPU 可以更快、更顺畅的渲染页面内容。随着 GPU 的发展，越来越多的计算任务也可以使用 GPU 来处理。甚至有人说 GPU 是人工智能的大功臣，可见 GPU 已经不再仅用于图像处理上了。

## 计算机架构

我们可以把计算机自下而上分成三层：硬件、操作系统和应用。有了操作系统的存在，上层运行的应用可以使用操作系统提供的能力使用硬件资源而不会直接访问硬件资源。

## 进程和线程

一个进程是应用正在运行的程序。而线程是进程中更小的一部分。当应用被启动，进程就被创建出来。程序可以创建线程来帮助其工作。操作系统会为进程分配私有的内存空间以供使用，当关闭程序时，这段私有的内存也会被释放。其实还有比线程更小的存在就是协程，而协成是运行在线程中更小的单位。async/await 就是基于协程实现的。

## 进程间通信（IPC）

一个进程可以让操作系统开启另一个进程处理不同的任务。当两个进程需要通信时，可以时用 IPC(Inter Process Communication)。

多数程序被设计成使用 IPC 来进行进程间的通信，好处在于当一个进程给另一个进程发消息而没有回应时，并不影响当前的进程继续工作。

## 浏览器基础架构

浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指 HTML 文档，也可以是 PDF、图片或其他的类型。资源的位置由用户使用 URI（统一资源标示符）指定。

浏览器解释并显示 HTML 文件的方式是在 HTML 和 CSS 规范中指定的。这些规范由网络标准化组织 W3C（万维网联盟）进行维护。
多年以来，各浏览器都没有完全遵从这些规范，同时还在开发自己独有的扩展程序，这给网络开发人员带来了严重的兼容性问题。如今，大多数的浏览器都是或多或少地遵从规范。

## 浏览器主要组件

现代浏览器的架构包括：

![浏览器的主要组件](https://cdn.clearlywind.com/blog-images/images/浏览器的主要组件.png)

1. 用户界面 - The User Interface

   包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。

   主要提供用户与 Browser Engine 交互的方法，浏览器除了渲染请求页面的窗口外的所有地方都属于 The User Interface。

2. 浏览器引擎 - The Browser Engine

   在用户界面和呈现引擎之间传送指令。协调（主控）UI 和 the Rendering Engine，在它们之间传输指令。 提供对 The Rendering Engine 的高级接口，一方面它提供初始化加载 Url 和其他高级的浏览器动作（如刷新、向前、退后等）方法。另一方面 Browser Engine 也为 User Interface 提供各种与错误、加载进度相关的消息。

3. 呈现引擎 - The Rendering Engine

   负责显示请求的内容，为给定的 URL 提供可视化的展示。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS；以及 JavaScript、XML 内容，并将解析后的内容显示在屏幕上。并且 User Interface 中展示的 Layout。其中关键的组件是 HTML 解析器，它可以让 Rendering Engine 展示差乱的 HTML 页面。 值得注意：不同的浏览器使用不同的 Rendering Engine。例如 IE 使用 Trident，Firefox 使用 Gecko，Safai 使用 Webkit。Chrome 和 Opera 使用 Webkit（以前是 Blink）

   具体工作过程可以查看[浏览器原理之呈现引擎](/blog/)

4. 网络 - The Networking

   用于网络调用，基于互联网 HTTP 和 FTP 协议，处理网络请求。网络模块负责：互联网通信和安全、字符集和 MIME 类型解析翻译。另外网络模块还提供获得到文档的缓存，以减少网络传输。为所有平台提供底层网络实现，其提供的接口与平台无关。

5. 用户界面后端 - The UI Backend

   用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。

6. JavaScript 解释器 - The JavaScript Interpreter

   用于解析和执行 JavaScript 代码。得到的结果传输到 Rendering Engine 来展示。

   GUI 渲染线程与 JavaScript 引擎线程是互斥的，所以如果 JavaScript 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。

   [浏览器运行原理之帧任务](/blog)

   [浏览器运行原理之 JavaScript 引擎](/blog)

7. 数据存储- The Data Storage

   这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。

> 和大多数浏览器不同，Chrome 浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。

## Chrome 的架构

借助进程和线程，浏览器可以被设计成单进程、多线程架构，或者利用 IPC 实现多进程、多线程架构。在 Chrome 中存在这不同种类型的进程，它们各司其职。Chrome 浏览器运行时的四个主要进程：

1. 浏览器进程

   浏览器进程负责管理 Chrome 应用本身，包括地址栏、书签、前进和后退按钮。同时也负责可不见的功能，比如网络请求、文件按访问等，也负责其他进程的调度。

2. GPU 进程 - GPU process

   GPU 进程负责提供成像的功能。

3. 第三方插件进程 - Plugin process

   插件进程负责为浏览器提供各种额外的插件功能，例如 flash。 4. 渲染进程(浏览器内核)

4. 渲染进程（Renderer process）主要负责站点的渲染，其中也包括 JavaScript 代码的运行，web worker 的管理等。

当然还有其他像扩展进程或工具进程等其他进程，可以在 Chrome 的 Task Manager 面板中查看，面板中列出了运行的进程和其占用的 CPU、内存情况。

## 多进程架构的好处

当我们访问一个站点时，渲染进程会负责运行站点的代码，渲染站点的页面，同时响应用户的交互动作，当我们在 Chrome 中打开三个页签同时访问三个站点时，如果其中一个没有响应，我们可以关闭它然后使用其他的页签，这是因为 Chrome 为每个站点创建一个独立的渲染进程，专门处理当前站点的渲染工作。如果所有的页面运行在同一个进程中，当有一个页面没有响应时，所有的页面就都卡住了。
